<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Heart Explosion</title>
  <style>
    body { margin: 0; background: black; overflow: hidden; }
    canvas { display: block; }
    #btn {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 12px 20px;
      background: red;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <button id="btn">bấm vào đây nè Trúc yeuu 💖</button>
  <canvas id="bg"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

  <script>
    let scene = new THREE.Scene();
    let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 120;

    let renderer = new THREE.WebGLRenderer({canvas: document.getElementById("bg"), antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);

    const particles = 10000;
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(particles * 3);

    function heart3D(t) {
      let x = 16 * Math.pow(Math.sin(t), 3);
      let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
      let z = (Math.random() - 0.5) * 20;
      return [x*2, y*2, z];
    }

    for (let i = 0; i < particles; i++) {
      let t = Math.random() * Math.PI * 2;
      let [x,y,z] = heart3D(t);
      positions[i*3] = x + (Math.random()-0.5)*10;
      positions[i*3+1] = y + (Math.random()-0.5)*10;
      positions[i*3+2] = z;
    }

    geometry.setAttribute("position", new THREE.BufferAttribute(positions, 3));
    let material = new THREE.PointsMaterial({color: 0xff2a2a, size: 0.6, transparent: true, opacity: 0.9});
    let points = new THREE.Points(geometry, material);
    scene.add(points);

    function animate() {
      requestAnimationFrame(animate);
      points.rotation.y += 0.0015;
      points.rotation.x = Math.sin(Date.now()*0.0002) * 0.1;
      renderer.render(scene, camera);
    }
    animate();

    function textToPoints(text) {
      let canvas = document.createElement("canvas");
      let ctx = canvas.getContext("2d");
      canvas.width = 800; canvas.height = 200;
      ctx.fillStyle = "white";
      ctx.font = "bold 120px Arial";
      ctx.fillText(text, 50, 150);
      let img = ctx.getImageData(0,0,800,200).data;

      let coords = [];
      for(let y=0; y<200; y+=4){
        for(let x=0; x<800; x+=4){
          let alpha = img[(y*800+x)*4+3];
          if(alpha > 128){
            coords.push([x-400, 100-y, 0]);
          }
        }
      }
      return coords;
    }

    let textPoints = textToPoints("anh yêu em nhiều 💕");

    document.getElementById("btn").onclick = () => {
      let pos = points.geometry.attributes.position.array;

      // 🔥 Step 1: Explosion (hạt nổ tung)
      for (let i=0; i<particles; i++) {
        let dx = (Math.random()-0.5)*400;
        let dy = (Math.random()-0.5)*400;
        let dz = (Math.random()-0.5)*400;
        gsap.to(pos, {
          [i*3]: dx,
          [i*3+1]: dy,
          [i*3+2]: dz,
          duration: 1.2,
          ease: "power3.out",
          onUpdate: ()=>{ points.geometry.attributes.position.needsUpdate = true; }
        });
      }

      // ⏳ Step 2: Gom lại thành chữ
      setTimeout(()=>{
        for (let i=0; i<particles; i++) {
          let target = textPoints[i % textPoints.length];
          gsap.to(pos, {
            [i*3]: target[0] + (Math.random()-0.5)*3,
            [i*3+1]: target[1] + (Math.random()-0.5)*3,
            [i*3+2]: target[2] + (Math.random()-0.5)*3,
            duration: 2,
            delay: i*0.0001,
            ease: "power2.out",
            onUpdate: ()=>{ points.geometry.attributes.position.needsUpdate = true; }
          });
        }
      }, 1500);
    };

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
